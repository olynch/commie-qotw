<html>
	<head>
		<link href = '/Flat-UI/dist/css/vendor/bootstrap.min.css' rel = 'stylesheet' />
		<link href = '/Flat-UI/dist/css/flat-ui.min.css' rel = 'stylesheet' />
		<link href = '/css/stylesheet.css' rel = 'stylesheet' />
		<script src = '/js/jquery.js'></script>
		<script src = '/js/nav.js'></script>
		<title>Vote</title>
		<script>
			function formatDate(date) {
				return ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][date.getDay()] + ' ' + ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][date.getMonth()] + ' ' + String(date.getDate()) + ', ' + String(date.getFullYear()) + ' at ' + String(date.getHours()) + ':' + String(date.getMinutes());
			}
			$(document).ready(function() {
				var postCol = $('div#post-col');
				$('button#show-post').click(function() {
					if (!postCol.children().length) {
						$(this).removeClass('btn-primary').addClass('btn-warning');
						$.ajax({
							'url': '/fetch/lastmessage',
							'dataType': 'json',
							'success': function(response) {
								$('button#show-post').removeClass('btn-warning').addClass('btn-primary');
								postCol.append(
									$('<div>').attr('id', 'last-message').addClass('panel').addClass('panel-default').append(
										$('<div>').addClass('panel-heading').text(response.title + ' (' + formatDate(new Date(response.timestamp)) + ')')
									).append(
										$('<div>').addClass('panel-body').html(response.body.replace(/\n/g, '<br />'))
									)
								);
							}
						});
					}
				});
				$('textarea#vote').keyup(function(e) {
					if (e.which == 13) submit();
					else {
						if ($(this).val()) $('button#submit').removeClass('btn-default').addClass('btn-success');
						else $('button#submit').removeClass('btn-success').addClass('btn-default');
					}
				});
				function submit() {
					if (!$('button#submit').hasClass('btn-success')) return;
					$('button#submit').removeClass('btn-success').addClass('btn-warning');
					$.ajax({
						'url': '/post/vote',
						'type': 'POST',
						'data': $('textarea#vote').val(),
						'dataType': 'json',
						'success': function(response) {
							if (response.success) $('button#submit').removeClass('btn-warning').addClass('btn-success');
							else $('button#submit').removeClass('btn-warning').addClass('btn-danger');
						},
						'error': function() {
							$('button#submit').removeClass('btn-warning').addClass('btn-danger');
							setTimeout(function() {
								$('button#submit').removeClass('btn-danger').addClass('btn-default');
							}, 1000);
						}
					});
					$('textarea#vote').val('');
				}
				$('button#submit').click(submit);
			});
		</script>
	</head>
	<body>
		<div id = 'body'>
			<div class = 'x-center'>
				<button id = 'show-post' class = 'btn btn-primary btn-hg'>Show post</button>
			</div>
			<div id = 'vote-row' class = 'row'>
				<div class = 'col-md-6'>
					<div class = 'panel panel-default'>
						<div class = 'panel-heading'>Vote</div>
						<div class = 'panel-body'>
							<textarea id = 'vote' class = 'form-control' placeholder = 'Vote' rows = 5></textarea>
							<button id = 'submit' class = 'btn btn-default'>Submit</button>
						</div>
					</div>
				</div>
				<div id = 'post-col' class = 'col-md-6'></div>
			</div>
		</div>
	</body>
</html>